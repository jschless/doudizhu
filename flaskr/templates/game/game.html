
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
  <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
  <script type="text/javascript" charset="utf-8">
    $(document).ready(function(){
      console.log('Javascript running')
      info = {game_id: '{{game.game_id}}',
              username: '{{current_user.username}}'};

      var socket = io();
      socket.on('connect', function () {
        console.log('connected with server')
        socket.emit('add to database', info);
      });

      socket.on('disconnect', info);

      $("#debug").click(function(){
        socket.emit('debug', info);
      });

      socket.on('update gameboard', function(data) {
        drawBoard(data);
      });

      $('#bidding').hide()
      socket.on('bid', function(max_bid){
        console.log('received bid request with minimum', max_bid);
        var radios = [0];
        if (max_bid < 1 ) radios.push(1)
        if (max_bid < 2) radios.push(2)
        radios.push(3)

        radios.forEach(value => {
          $('#bidding')
          .append(`<input type="radio" id="${value}" name="bid" value="${value}">`)
          .append(`<label for="${value}">${value}</label></div>`)
          .append(`<br>`);
        });

        $('#bidding').append('<input id="submit_bid" type="submit" name="submit bid" value="Submit Bid">')

        $('#bidding').show()
        $('#submit_bid').click(function() {
          let bid = $('input[name="bid"]:checked').val();
          console.log('submitting bid', bid);
          socket.emit('submit bid', {info, bid: bid});
          $('#bidding').hide()
        });
      });

      $('#move_stuff').hide()

      socket.on('make move', function(){
        $("#move_flash").text("It's your move!").css('color', 'red');
        lockCards = false;
        hand = [];
        discard = [];
        $('#move_stuff').show();
      });

      socket.on('round over', function(winner){
        setTimeout(() => socket.emit("next round", info.game_id), 10000);
      });

      socket.on('flash', (m) => $("#flash").text(m).css('color', 'red'));

      socket.on('flash append', (m) => $("#flash").text(
        $("#flash").text() + ' , ' + m).css('color', 'red'));


      function drawBoard(data){
        console.log('received data to display', data);

        $("#gameboard").empty();
        $("#gameboard").append('<h2>Users currently in lobby:</h2>', 
        '<ul></ul>'); 

        $.each(data['usernames'], function(i){
          $("#gameboard").append($("<li></li>").text(data['usernames'][i]));
        });

        $("#gameboard").append('<h2>Current Round</h2>',
        $("<p></p>").text("Hand Type: " + data['hand_type']),
        $("<p></p>").text("Discard Type: " + data['discard_type']))

        // Last hand 
        if (data['hand_history'].length > 0) {
          let lastMove = data['hand_history'][data['hand_history'].length-1]
          $("#gameboard").append('<div id="last_move"></div');
          $("#last_move").empty();
          $("#last_move").append('<h4>Last Move</h4>');
          addImages(lastMove[0], "#last_move")
          if (lastMove[1].length > 0) {
            $("#last_move").append('<br>');            
            addImages(lastMove[1], "#last_move");
          }
          
        } 
        drawCards(data['hand']);
      }

      function addImages(arr, jquery) {
        arr.forEach(card => {
          let img = $('<img />');
          img.attr('id', card);
          img.attr('src', '/static/card-images/' + cardToImage(card));
          img.attr('width', '50px');
          $(jquery).append(img);
      });
    }

      var hand = [];
      var discard = [];
      let lockCards = true; 

      function drawCards(cards){
        $("#cards").empty();
        addImages(cards, "#cards")

        $("img").mousedown(function(event) {
          // https://stackoverflow.com/questions/10170280/jquery-selecting-image
          if (lockCards) return; // stop everyting unless it's your time to make a move
            switch (event.which) {
                case 1:
                  if($(this).hasBorder()) {
                    $(this).css("border", "");
                    hand.pop($(this).attr("id"))
                    //you can remove the id from array if you need to
                  }
                  else {
                    $(this).css("border", "2px solid red");
                    hand.push($(this).attr("id")); //something like this 
                  }
                  break;
                case 3:
                  if($(this).hasBorder()) {
                    $(this).css("border", "");
                    discard.pop($(this).attr("id"))
                    //you can remove the id from array if you need to
                  }
                  else {
                    $(this).css("border", "2px solid blue");
                    discard.push($(this).attr("id")); //something like this 
                  }
                  break;
                default:
                    console.log('Button click not implemented');
            }
            console.log('hand', hand, 'discard', discard);
       });
      }

      function submitMove(){
        socket.emit('submit move', {info: info, move: hand, discard: discard});
        hand = [];
        discard = [];
        $("#move_stuff").hide();
        $("#move_flash").text("");
        $("img").css("border", "");
        lockCards = true;
      }

      $("#submit_move").click(submitMove);

      $("#pass_move").click(function(){
        hand = [];
        discard = [];
        submitMove();
      });

      card_to_string = {
        11: "jack",
        12: "queen",
        13: "king", 
        14: "1",
        15: "2",
        16: "joker_black",
        17: "joker_red"
      }

      function cardToImage(card){
        // Takes a card (int) and gets the card picture
        if (card == 16 | card == 17) {
          return card_to_string[card] + '.png'
        }
        else if (card in card_to_string) {
          return "club_" + card_to_string[card] + '.png'
        }
        else {
          return "club_" + card.toString() + '.png'
        }
      }

      $.fn.hasBorder = function() {   
        if ((this.outerWidth() - this.innerWidth() > 0) ||  (this.outerHeight() - this.innerHeight() > 0)){
              return true;
          }
          else{
              return false;
          }
      };
    });
  </script>
{% extends 'base.html' %}

{% block content %}
  <h1>Game ID: {{ game.game_id }} </h1>
  <h2 id="flash"></h2>
  <input id="debug" type="submit" name="start_game" value="Start Game">

  <div id="gameboard"></div>

  <h2>Your Hand</h2>
  <div id="move_flash"></div>
  <div id="cards">
  </div>
  <div id="move_stuff">
    <input id="submit_move" type="submit" name="submit move" value="Submit Move">
    <input id="pass_move" type="submit" name="submit bid" value="Pass">  
  </div>

  <div id="bidding">
    <h2>Make your bid</h2>
  </div>
{% endblock %}
